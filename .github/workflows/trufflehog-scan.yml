name: TruffleHog Secret Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

# Default exclusion patterns (regex format)
# Supports: exact filenames, wildcards, regex patterns
# Examples:
#   Exact file:     ^config/settings\.json$
#   Directory:      ^node_modules/
#   Extension:      \.lock$
#   Wildcard:       .*\.min\.js$
#   Regex:          ^src/test/.*_test\.py$

env:
  DEFAULT_EXCLUDES: |
    ^node_modules/
    ^vendor/
    ^\.git/
    \.lock$
    ^package-lock\.json$
    ^yarn\.lock$
    ^pnpm-lock\.yaml$
    \.min\.js$
    \.min\.css$

jobs:
  trufflehog-scan:
    name: Scan PR for Secrets
    runs-on: ubuntu-latest
    # Run pull_request_target only for fork PRs, pull_request only for same-repo PRs
    # This prevents duplicate runs
    if: |
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository) ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR head commits
        if: github.event_name != 'workflow_dispatch'
        run: |
          # Fetch PR commits using GitHub's merge ref (works for all PRs including forks)
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:refs/remotes/origin/pr-head
          echo "Fetched PR #${{ github.event.pull_request.number }} head commit: ${{ github.event.pull_request.head.sha }}"

      - name: Setup exclude config
        id: config
        run: |
          if [ -n "${{ vars.TRUFFLEHOG_EXCLUDES }}" ]; then
            echo "Using repo/org-level TRUFFLEHOG_EXCLUDES variable"
            # Support both comma-separated and newline-separated patterns
            echo "${{ vars.TRUFFLEHOG_EXCLUDES }}" | tr ',' '\n' | sed '/^$/d' > .trufflehog-ignore
          else
            echo "Using default exclusions from central workflow"
            cat << 'EOF' > .trufflehog-ignore
          ${{ env.DEFAULT_EXCLUDES }}
          EOF
          fi
          
          echo "Exclusion patterns:"
          cat .trufflehog-ignore
          echo "exclude_args=--exclude-paths=.trufflehog-ignore" >> $GITHUB_OUTPUT

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: ${{ steps.config.outputs.exclude_args }}
